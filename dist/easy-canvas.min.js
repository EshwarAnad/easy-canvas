!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).easyCanvas=e()}(this,(function(){"use strict";const t={BLOCK:"block",INLINE_BLOCK:"inline-block",INLINE:"inline",FLEX:"flex",NONE:"none"},e={AUTO:"auto",OUTER:"100%"},i={ROW:"row",COLUMN:"column"};var s={DISPLAY:t,WIDTH:e,POSITION:{ABSOLUTE:"absolute",FIXED:"fixed",RELATIVE:"relative",STATIC:"static"},DEFAULT_STYLES:{display:t.BLOCK,fontSize:14,fontWeight:400,fontFamily:"Microsoft Yahei",color:"#000",paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginTop:0,marginBottom:0,marginLeft:0,marginRight:0,height:e.AUTO,borderRadius:0,lineCap:"square",flexDirection:i.ROW,verticalAlign:"top",whiteSpace:"normal",zIndex:1},TEXT_ALIGN:{LEFT:"left",RIGHT:"right",CENTER:"center"},FLEX_DIRECTION:i};function n(t){return"number"==typeof t}function r(t){return"auto"===t}function h(t){if("string"==typeof t)return t.match("%")}function o(t){let e=parseInt(t.replace("%",""));return isNaN(e)||e<0?0:e/100}function l(t,e){e(t),t.hasChildren()&&t._getChildren().forEach(t=>{l(t,e)})}class d{constructor(t,e){this.options=Object.assign({attrs:{},styles:{},on:{}},t),this.children=e,this.styles=null,this.parent=null,this.renderStyles=null,this.x=0,this.y=0,this.pre=null,this.next=null,this.render=null,this.root=null,this.container=null}init(){this._initStyles(),this.initEvent()}initEvent(){const{click:t}=this.options.on;if(t){const{click:t}=this.options.on;this.getLayer().eventManager.onClick(t,this)}}removeEvent(){this.getLayer().eventManager.removeElement(this)}getLayer(){return this.root.layer}mount(t){t.mountNode(this)}_restore(t){this.getCtx().save(),t(),this.getCtx().restore()}_path(t){this.getCtx().beginPath(),t(),this.getCtx().closePath()}_initStyles(){this.styles=Object.assign({},this._getDefaultStyles(),this._getParentStyles(),this.options.styles||{}),this._completeStyles(),this.renderStyles={...this.styles}}_getParentStyles(){let{textAlign:t,lineHeight:e,fontSize:i,color:s,fontFamily:n,alignItems:r}=this.parent&&this.parent.styles||{},h={};return t&&(h.textAlign=t),e&&(h.lineHeight=e),i&&(h.fontSize=i),s&&(h.color=s),n&&(h.fontFamily=n),"flex-start"===r&&(h.verticalAlign="top"),"center"===r&&(h.verticalAlign="middle"),"flex-end"===r&&(h.verticalAlign="bottom"),h}_completeStyles(){this._completeFlex(),this._completeWidth(),this._completeBorder()}_completeBorder(){let{borderWidth:t,borderLeftWidth:e,borderRightWidth:i,borderBottomWidth:s,borderTopWidth:n,borderRadius:r}=this.styles;t||(this.styles.borderWidth=0,t=0),Array.isArray(t)?(this.styles.borderTopWidth=t[0],this.styles.borderRightWidth=t[1],this.styles.borderBottomWidth=t[2],this.styles.borderLeftWidth=t[3]):(e||(this.styles.borderLeftWidth=t),i||(this.styles.borderRightWidth=t),s||(this.styles.borderBottomWidth=t),n||(this.styles.borderTopWidth=t)),r&&(this.styles.overflow="hidden")}_completeWidth(){this.styles.width||this.styles.flex||(this.styles.display!==s.DISPLAY.INLINE_BLOCK&&this.styles.display!==s.DISPLAY.INLINE&&this.isInFlow()?this.styles.display!==s.DISPLAY.BLOCK&&this.styles.display!==s.DISPLAY.FLEX||(this.styles.width=s.WIDTH.OUTER):this.styles.width=s.WIDTH.AUTO)}_completeFlex(){this.parent&&this.parent.styles.display===s.DISPLAY.FLEX&&(this.styles.width||this.styles.flex||(this.styles.flex=1))}_getDefaultStyles(){return s.DEFAULT_STYLES}tree2List(){this.root=this;let t=this._connectChildren();return Array.isArray(t)?t:[t]}_connectChildren(){if(this.hasChildren()){const t=this._getChildren().map((t,e)=>(t._setParent(this),t._setSibling(this._getChildren()[e-1],this._getChildren()[e+1]),t._connectChildren())).reduce((t,e)=>[...t,...e]);return[this._generateRender(),...t]}return[this._generateRender()]}hasChildren(){return!(!Array.isArray(this.children)||!this.children.length)}_getChildren(){return this.hasChildren()?this.children:[]}_getChildrenInFlow(){return this._getChildren().filter(t=>t.isInFlow())}isInFlow(){const{position:t,display:e}=this.styles;return t!==s.POSITION.ABSOLUTE&&t!==s.POSITION.FIXED}_setParent(t){this.parent=t,this.root=t.root}_setSibling(t,e){this.pre=t,this.next=e}_generateRender(){return this}getCtx(){return this.root.layer.ctx}_reflow(){this._initStartingPoint(),this._walkParentLayout(),this._calcContentLayout(),this._patchAlign()}_repaint(){this.getCtx().save(),this._drawBox(),this._drawBackground(),this._drawContent()}_afterPaint(){if(this.hasChildren()||this.getCtx().restore(),this.parent&&!this.next&&!this.hasChildren()){this.getCtx().restore();let t=this.parent;for(;t&&!t.next;)this.getCtx().restore(),t=t.parent}}_drawBox(){}_drawContent(){}_drawBackground(){}_initLayout(){this._initClearWidthHeight(),this._calcContentLayout(),this._walkParentLayout(),this._initStartingPoint()}_initStartingPoint(){if(this.isInFlow())this._needNewLine()?(this.x=this._getContainerLayout().contentX,this.y=this._getPreLayout().y+this._getPreLayout().height):(this.x=this._getPreLayout().x+this._getPreLayout().width,this.y=this._getPreLayout().y);else{const{top:t,bottom:e,right:i,left:s,width:r,height:h}=this.renderStyles;let{contentX:o,contentY:l,contentWidth:d,contentHeight:a}=this._getContainerLayout();n(t)?this.y=l+t:n(e)&&(this.y=l+a-e-h),n(s)?this.x=o+s:n(i)&&(this.x=o+d-i-r)}}_walkParentLayout(){if(this.next||this.hasChildren())return;if(!this.isInFlow())return;let t=this;for(;t.parent&&(t.parent.styles.width===s.WIDTH.AUTO||t.parent.styles.height===s.WIDTH.AUTO);)t.parent._calcLayoutWithChildren(),t=t.parent}_initClearWidthHeight(){const{width:t,height:e,display:i,flex:r,marginLeft:l,marginRight:d,marginTop:a,marginBottom:g}=this.styles,c=this._measureLayout();r&&this.parent&&this.parent.renderStyles.display===s.DISPLAY.FLEX?this.renderStyles.width=this._getFlexWidth():h(t)?this.renderStyles.width=this._getContainerLayout().contentWidth*o(t):t===s.WIDTH.AUTO?this.renderStyles.width=c.width:n(t)&&(this.renderStyles.width=t+l+d),h(e)?this.renderStyles.height=this._getContainerLayout().contentHeight*o(e):e===s.WIDTH.AUTO?this.renderStyles.height=c.height:n(e)&&(this.renderStyles.height=e+a+g),this.renderStyles.marginTop=this.styles.borderTopWidth+this.styles.marginTop,this.renderStyles.marginBottom=this.styles.borderBottomWidth+this.styles.marginBottom,this.renderStyles.marginLeft=this.styles.borderLeftWidth+this.styles.marginLeft,this.renderStyles.marginRight=this.styles.borderRightWidth+this.styles.marginRight}_calcLayoutWithChildren(){const{width:t,height:e}=this.styles;t===s.WIDTH.AUTO&&(this.renderStyles.contentWidth=this._calcContentWidthWidthChildren()),e===s.WIDTH.AUTO&&(this.renderStyles.contentHeight=this._calcContentHeightWidthChildren()),this._calcLayoutWithContent()}_calcLayoutWithContent(){this.renderStyles.height=this.renderStyles.contentHeight+this.renderStyles.paddingTop+this.renderStyles.paddingBottom+this.renderStyles.marginTop+this.renderStyles.marginBottom,this.renderStyles.width=this.renderStyles.contentWidth+this.renderStyles.paddingLeft+this.renderStyles.paddingRight+this.renderStyles.marginLeft+this.renderStyles.marginRight}_calcContentLayout(){const t=function(t){let e=t.renderStyles.width,i=t.renderStyles.height;n(e)||(e=0);n(i)||(i=0);t.renderStyles.minWidth&&e<t.renderStyles.minWidth&&(e=t.renderStyles.width=t.renderStyles.minWidth);t.renderStyles.maxWidth&&e>t.renderStyles.maxWidth&&(e=t.renderStyles.width=t.renderStyles.maxWidth);t.renderStyles.maxHeight&&i>t.renderStyles.maxHeight&&(i=t.renderStyles.height=t.renderStyles.maxHeight);t.renderStyles.minHeight&&i>t.renderStyles.minHeight&&(i=t.renderStyles.height=t.renderStyles.minHeight);return{contentWidth:e-t.renderStyles.paddingLeft-t.renderStyles.paddingRight-t.renderStyles.marginLeft-t.renderStyles.marginRight,contentHeight:i-t.renderStyles.paddingTop-t.renderStyles.paddingBottom-t.renderStyles.marginTop-t.renderStyles.marginBottom,contentX:t.x+t.renderStyles.paddingLeft+t.renderStyles.marginLeft,contentY:t.y+t.renderStyles.paddingTop+t.renderStyles.marginTop,width:e,height:i}}(this);this.renderStyles.contentWidth=t.contentWidth,this.renderStyles.contentHeight=t.contentHeight,this.contentX=t.contentX,this.contentY=t.contentY}_calcContentWidthWidthChildren(){let t=0,e=t;return this._getChildrenInFlow().forEach(i=>{i._needNewLine()&&(e=0),e+=i.renderStyles.width,e>t&&(t=e)}),t}_getFlexWidth(){if(!this.renderStyles.flex)return 0;const t=this._getContainerLayout().contentWidth;let e=0,i=0;return this.parent._getChildrenInFlow().forEach(t=>{n(t.styles.width)?e+=t.styles.width:t.renderStyles.flex&&(i+=t.renderStyles.flex)}),(t-e)*(this.renderStyles.flex/i)}_calcContentHeightWidthChildren(){let t=!0,e=0;const i=[];return this._getChildrenInFlow().forEach(s=>{"number"===(s.renderStyles.height,!1)&&(t=!1),s._needNewLine()?(i.push(e),e=s.renderStyles.height):s.renderStyles.height>e&&(e=s.renderStyles.height),s.next||(i.push(e),e=0)}),t?i.reduce((t,e)=>t+(e>=0?e:0)):this.renderStyles.height}_needNewLine(){const{display:t}=this.renderStyles,{whiteSpace:e}=this.parent&&this.parent.renderStyles||{};if(this.parent&&this.parent.renderStyles.display===s.DISPLAY.FLEX&&this.pre&&this.parent.renderStyles.flexDirection===s.FLEX_DIRECTION.ROW)return!1;if(t===s.DISPLAY.BLOCK||t===s.DISPLAY.FLEX)return!0;if("nowrap"===e)return!1;if(!this.pre)return!0;{let{width:t}=this.renderStyles;t===s.WIDTH.AUTO&&(t=0);const{display:e,width:i}=this.pre.renderStyles,{width:n,x:r}=this._getContainerLayout();if(e===s.DISPLAY.BLOCK||e===s.DISPLAY.FLEX)return!0;if(i+this.pre.x+t>r+n)return!0}return!1}_getContainerLayout(){let t=this.parent;return this.styles.position,s.POSITION.STATIC,t||(t={renderStyles:{width:this.container.width,height:this.container.height,paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginLeft:0,marginRight:0,marginTop:0,marginBottom:0,contentWidth:this.container.width,contentHeight:this.container.height},x:0,y:0,contentX:0,contentY:0}),{width:t.renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y,paddingTop:t.renderStyles.paddingTop,paddingBottom:t.renderStyles.paddingBottom,paddingLeft:t.renderStyles.paddingLeft,paddingRight:t.renderStyles.paddingRight,marginLeft:t.renderStyles.marginLeft,marginRight:t.renderStyles.marginRight,marginTop:t.renderStyles.marginTop,marginBottom:t.renderStyles.marginBottom,contentX:t.contentX,contentY:t.contentY,contentWidth:t.renderStyles.contentWidth,contentHeight:t.renderStyles.contentHeight}}_getPreLayout(){let t=this.pre;for(;t&&!t.isInFlow();)t=t.pre;return t?{width:t.renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y}:{width:0,height:0,x:this._getContainerLayout().contentX,y:this._getContainerLayout().contentY}}_measureLayout(){return{width:0,height:0,x:0,y:0}}_px(t){return t}_patchAlign(){if(!this.parent)return;if(this.renderStyles.display!==s.DISPLAY.INLINE_BLOCK&&this.parent.renderStyles.display!==s.DISPLAY.FLEX)return;const t=this.parent.renderStyles.textAlign;this.renderStyles.verticalAlign;let e,i,n=0;const r=t=>{t.x+=i,t.contentX+=i,t._getChildrenInFlow().forEach(t=>l(t,t=>t.isInFlow()&&t._reflow()))},h=t=>{let e=0;"middle"===t.renderStyles.verticalAlign?e=(n-t.renderStyles.height)/2:"bottom"===t.renderStyles.verticalAlign&&(e=n-t.renderStyles.height),t.y+=e,t.contentY+=e,t._getChildrenInFlow().forEach(t=>l(t,t=>t.isInFlow()&&t._reflow()))},o=()=>{i="right"===t?this._getContainerLayout().contentWidth+this._getContainerLayout().contentX-e.x-e.renderStyles.width:"center"===t?(this._getContainerLayout().contentWidth+this._getContainerLayout().contentX-e.x-e.renderStyles.width)/2:0},d=()=>{e.renderStyles.height<=n||(n=e.renderStyles.height)};if(!this._needNewLine()&&this.next||!this.pre)this.next||this.pre||(e=this,o(),r(e));else{for(e=this.pre,this.next||(e=this,this._needNewLine()&&(o(),r(e),e=this.pre)),o();e&&(d(),r(e),e=e.pre,e);)if(e._needNewLine()){d(),r(e);break}for(e=this.pre,this.next||(e=this);e&&(h(e),e=e.pre,e);)if(e._needNewLine()){h(e);break}}}getElementBy(t,e){let i=[];return l(this,s=>{s.options.attrs[t]===e&&i.push(s)}),i}appendChild(t){if(!t instanceof d)throw Error("Unknown Element type");return this.children.push(t),this._connectChildren(),this.getLayer().initNode(t),this.getLayer().flow(),this.getLayer().repaint(),t}prependChild(t){if(!t instanceof d)throw Error("Unknown Element type");return this.children.unshift(t),this._connectChildren(),this.getLayer().initNode(t),this.getLayer().flow(),this.getLayer().repaint(),t}removeChild(t){if(!t instanceof d)throw Error("Unknown Element type");const e=this._getChildren().indexOf(t);if(e<0)throw Error("Element must be the child of parent");const i=this._getChildren()[e-1],s=this._getChildren()[e+1];i&&i._setSibling(i.pre,s),s&&s._setSibling(i,s.next),this.children.splice(e,1),t.removeEvent(),this.getLayer().reflow(),this.getLayer().repaint()}append(t){if(!t instanceof d)throw Error("Unknown Element type");if(!this.parent)throw Error("Can not add element to root level!");let e=[];this.parent.children.forEach(i=>{e.push(i),i===this&&e.push(t)}),this.parent.children=e,this.parent._connectChildren(),this.getLayer().initNode(t),this.getLayer().flow(),this.getLayer().repaint()}prepend(t){if(!t instanceof d)throw Error("Unknown Element type");if(!this.parent)throw Error("Can not add element to root level!");let e=[];for(let i=this.parent.children.length-1;i>=0;i--)e.unshift(this.parent.children[i]),this.parent.children[i]===this&&e.unshift(t);this.parent.children=e,this.parent._connectChildren(),this.getLayer().initNode(t),this.getLayer().flow(),this.getLayer().repaint()}}class a extends d{_getDefaultStyles(){return{...s.DEFAULT_STYLES,display:s.DISPLAY.BLOCK}}_completeStyles(){super._completeStyles(),this._completePaddingMargin()}_completePaddingMargin(){this.styles.padding&&(n(this.styles.padding)?(this.styles.paddingLeft=this.styles.padding,this.styles.paddingBottom=this.styles.padding,this.styles.paddingRight=this.styles.padding,this.styles.paddingTop=this.styles.padding):Array.isArray(this.styles.padding)&&(2===this.styles.padding.length?(this.styles.paddingLeft=this.styles.paddingRight=this.styles.padding[1],this.styles.paddingBottom=this.styles.paddingTop=this.styles.padding[0]):4===this.styles.padding.length&&(this.styles.paddingLeft=this.styles.padding[3],this.styles.paddingBottom=this.styles.padding[2],this.styles.paddingRight=this.styles.padding[1],this.styles.paddingTop=this.styles.padding[0]))),this.styles.margin?(this.styles.marginLeft=this.styles.margin,this.styles.marginBottom=this.styles.margin,this.styles.marginRight=this.styles.margin,this.styles.marginTop=this.styles.margin):Array.isArray(this.styles.margin)&&(2===this.styles.margin.length?(this.styles.marginLeft=this.styles.marginRight=this.styles.margin[1],this.styles.marginBottom=this.styles.marginTop=this.styles.margin[0]):4===this.styles.margin.length&&(this.styles.marginLeft=this.styles.margin[3],this.styles.marginBottom=this.styles.margin[2],this.styles.marginRight=this.styles.margin[1],this.styles.marginTop=this.styles.margin[0]))}_reflow(){super._reflow()}_repaint(){super._repaint()}_afterPaint(){super._afterPaint()}_drawBackground(){const{backgroundColor:t,contentWidth:e,contentHeight:i,paddingLeft:s,paddingRight:r,paddingTop:h,paddingBottom:o,opacity:l}=this.renderStyles,d=this.getCtx();n(l)&&(d.globalAlpha=l),this._clip(),t&&(this.getCtx().fillStyle=t,this.getCtx().fillRect(this.contentX-s,this.contentY-h,e+s+r,i+h+o))}_drawBox(){this._drawRadiusBorder(),this.getLayer().options&&this.getLayer().options.debug&&(this.getCtx().strokeStyle="green",this.getCtx().strokeRect(this.contentX,this.contentY,this.renderStyles.contentWidth,this.renderStyles.contentHeight))}_drawRadiusBorder(){if(!this.renderStyles.borderColor&&!this.renderStyles.shadowBlur)return;const{contentWidth:t,contentHeight:e,paddingLeft:i,paddingTop:s,borderStyle:r,paddingRight:h,paddingBottom:o,shadowBlur:l,shadowColor:d,backgroundColor:a,shadowOffsetX:g,shadowOffsetY:c,borderLeftWidth:y,borderRightWidth:p,borderTopWidth:u,borderBottomWidth:m}=this.renderStyles,f=Math.PI/2;let _=this._getBorderRadius(),S=this.contentX-this.renderStyles.paddingLeft-y/2,L=this.contentY-this.renderStyles.paddingTop-u/2,w=t+i+h+(y+p)/2,x=e+s+o+(u+m)/2;const C=()=>{this.getCtx().moveTo(S,L+_),_&&this.getCtx().arc(S+_,L+_,_,2*f,3*f),this.getCtx().lineTo(S+w-_,L)},T=()=>{_&&this.getCtx().arc(S+w-_,L+_,_,3*f,4*f),this.getCtx().lineTo(S+w,L+x-_)},I=()=>{_&&this.getCtx().arc(S+w-_,L+x-_,_,0,f),this.getCtx().lineTo(S+_,L+x)},W=()=>{_&&this.getCtx().arc(S+_,L+x-_,_,f,2*f),this.getCtx().lineTo(S,L+_)};this.getCtx().lineCap=this.renderStyles.lineCap,this.getCtx().strokeStyle=this.renderStyles.borderColor,"dash"===r&&(n(r)?this.getCtx().lineDashOffset=r:this.getCtx().lineDashOffset=1);const E=t=>{this.getCtx().lineWidth=t,this.getCtx().stroke()};d&&l&&this._restore(()=>{this._path(()=>{C(),T(),I(),W()}),n(g)&&(this.getCtx().shadowOffsetX=g),n(c)&&(this.getCtx().shadowOffsetY=c),this.getCtx().shadowBlur=l,this.getCtx().shadowColor=d,this.getCtx().fillStyle=d,this.getCtx().fill()}),this._restore(()=>{this._path(()=>{S=this.contentX-this.renderStyles.paddingLeft-y/2,L=this.contentY-this.renderStyles.paddingTop-u/2,w=t+i+h+(y+p)/2,x=e+s+o+(u+m)/2,this.renderStyles.borderTopWidth&&(C(),E(this.renderStyles.borderTopWidth)),this.renderStyles.borderRightWidth&&(this.getCtx().moveTo(S+w-_,L),T(),E(this.renderStyles.borderRightWidth)),this.renderStyles.borderBottomWidth&&(this.getCtx().moveTo(S+w,L+x-_),I(),E(this.renderStyles.borderBottomWidth)),this.renderStyles.borderLeftWidth&&(this.getCtx().moveTo(S+_,L+x),W(),E(this.renderStyles.borderLeftWidth))})})}_clip(){if("hidden"!==this.renderStyles.overflow)return;const{contentWidth:t,contentHeight:e,paddingLeft:i,paddingTop:s,paddingRight:n,paddingBottom:r,shadowBlur:h,shadowColor:o,backgroundColor:l,borderLeftWidth:d,borderRightWidth:a,borderTopWidth:g,borderBottomWidth:c}=this.renderStyles,y=Math.PI/2;let p=this._getBorderRadius(),u=this.contentX-this.renderStyles.paddingLeft-d,m=this.contentY-this.renderStyles.paddingTop-g,f=t+i+n+d+a,_=e+s+r+g+c;const S=()=>{this.getCtx().moveTo(u,m+p),p&&this.getCtx().arc(u+p,m+p,p,2*y,3*y),this.getCtx().lineTo(u+f-p,m)},L=()=>{p&&this.getCtx().arc(u+f-p,m+p,p,3*y,4*y),this.getCtx().lineTo(u+f,m+_-p)},w=()=>{p&&this.getCtx().arc(u+f-p,m+_-p,p,0,y),this.getCtx().lineTo(u+p,m+_)},x=()=>{p&&this.getCtx().arc(u+p,m+_-p,p,y,2*y),this.getCtx().lineTo(u,m+p)};this._path(()=>{S(),L(),w(),x()}),this.getCtx().clip()}_getBorderRadius(){const{contentWidth:t,contentHeight:e}=this.renderStyles;let{borderRadius:i}=this.renderStyles;return 2*i>t&&(i=t/2),2*i>e&&(i=e/2),i<0&&(i=0),i}}class g extends d{constructor(t,e){super(t,e),this._layout=null,this._lines=[],this.children+=""}_getDefaultStyles(){return{...s.DEFAULT_STYLES,display:s.DISPLAY.INLINE,width:s.WIDTH.AUTO,textAlign:"left"}}_completeStyles(){super._completeStyles(),this._completeFont()}_completeWidth(){super._completeWidth(),"left"!==this.styles.textAlign&&this.parent&&!r(this.parent.styles.width)&&(this.styles.width="100%")}_completeFont(){this.styles.fontSize&&!this.styles.lineHeight?this.styles.lineHeight=1.4*this.styles.fontSize:this.styles.lineHeight||(this.styles.lineHeight=14)}_initLayout(){this._restore(()=>{this.getCtx().font=this._getFont(),this._layout=this.getCtx().measureText(this.children),this._layout.fontHeight=this.renderStyles.fontSize,this._layout.height=this.renderStyles.lineHeight,this._calcLine()}),super._initLayout()}_measureLayout(){return this._layout}_drawContent(){const{color:t,contentWidth:e,lineHeight:i,textAlign:n}=this.renderStyles;let r=this.contentX;this.getCtx().fillStyle=t,this.getCtx().textAlign=n,this.getCtx().font=this._getFont(),n===s.TEXT_ALIGN.RIGHT?r=this.contentX+e:n===s.TEXT_ALIGN.CENTER&&(r=this.contentX+e/2),this._lines.forEach((t,e)=>{this.getCtx().fillText(t,r,this.contentY+this._layout.fontHeight+(i-this._layout.fontHeight)/2+i*e-1)})}_getFont(){const{fontSize:t,fontWeight:e,fontFamily:i}=this.renderStyles;return`${e} ${t}px ${i}`}_calcLine(){if(!this.parent||!this.children)return;const{width:t,height:e}=this._layout,{contentWidth:i}=this.parent.renderStyles,{width:r}=this.parent.styles;if(n(i)&&i>=t||r===s.WIDTH.AUTO)this._lines=[this.children];else{this._lines=[];let t=1,e="",s=null;for(let n=0;n<this.children.length;n++){if(s=this.getCtx().measureText(e+this.children[n]),s.width>i){if(t>=this.renderStyles.maxLine){e=e.substring(0,e.length-2)+"...";break}this._lines.push(e),e="",t+=1}e+=this.children[n]}this._lines.push(e)}this._layout.height=this._lines.length*this.renderStyles.lineHeight}}class c extends a{init(){super.init(),this._imageInfo={width:0,height:0,sx:0,sy:0,swidth:0,sheight:0,dx:0,dy:0,dwidth:0,dheight:0},this._image=null,this._loadImage()}_loadImage(){return new Promise((t,e)=>{var i,s;(i=this.options.attrs.src,s=this.getLayer().getCanvas(),new Promise((t,e)=>{let n=null;n=window?new Image:s.createImage(),n.src=i,n.onload=function(e){t({image:n,info:{width:e.target.width,height:e.target.height}})}})).then(({info:e,image:i})=>{this._imageInfo=e,this._image=i,t(),this._layoutImage(),this.getLayer().reflow(),this.getLayer().repaint(),this.options.on&&this.options.on.load&&this.options.on.load(this)})})}_drawContent(){if(!this._image)return;const{contentWidth:t,contentHeight:e}=this.renderStyles,{mode:i}=this.options.attrs,{sx:s,sy:n,swidth:r,sheight:h,dx:o,dy:l,dwidth:d,dheight:a,width:g,height:c}=this._imageInfo;"aspectFill"===i?this.getCtx().drawImage(this._image,s,n,r,h,this.contentX,this.contentY,t,e):"aspectFit"===i?this.getCtx().drawImage(this._image,0,0,g,c,o,l,d,a):this.getCtx().drawImage(this._image,this.contentX,this.contentY,t,e)}_layoutImage(){const{contentWidth:t,contentHeight:e}=this.renderStyles,{mode:i}=this.options.attrs,{width:s,height:n}=this.styles,{width:h,height:o}=this._imageInfo;let l=t,d=e;!r(s)&&r(n)?(l=t,d=p(l,h,o)):!r(n)&&r(s)?(d=e,l=y(d,h,o)):r(s)&&r(n)?(l=h,d=o):"aspectFill"===i?l/d>h/o?(this._imageInfo.swidth=h,this._imageInfo.sheight=p(h,l,d),this._imageInfo.sx=0,this._imageInfo.sy=(o-this._imageInfo.sheight)/2):(this._imageInfo.sheight=o,this._imageInfo.swidth=y(o,t,e),this._imageInfo.sy=0,this._imageInfo.sx=(h-this._imageInfo.swidth)/2):"aspectFit"===i?l/d>h/o?(this._imageInfo.dwidth=y(e,h,o),this._imageInfo.dheight=e,this._imageInfo.dy=this.contentY,this._imageInfo.dx=(t-this._imageInfo.dwidth)/2+this.contentX):(this._imageInfo.dheight=p(t,h,o),this._imageInfo.dwidth=t,this._imageInfo.dx=this.contentX,this._imageInfo.dy=(e-this._imageInfo.dheight)/2+this.contentY):(l=t,d=e),this.renderStyles.contentWidth=l,this.renderStyles.contentHeight=d,this._calcLayoutWithContent()}}function y(t,e,i){return t/i*e}function p(t,e,i){return t/e*i}class u{constructor({simulateClick:t=!0}){this.clickList=[],this.touchstartList=[],this.touchmoveList=[],this.touchendList=[],this.touchStartEvent=null,this.simulateClick=t}clear(){this.clickList=[],this.touchstartList=[],this.touchmoveList=[],this.touchendList=[]}click(t,e){let i=new m({x:t,y:e,type:"click"});this._emit(i)}touchstart(t,e){let i=new m({x:t,y:e,type:"touchstart"});this.touchStartEvent=i,this._emit(i)}touchmove(t,e){let i=new m({x:t,y:e,type:"touchmove"});this._emit(i)}touchend(t,e){let i=new m({x:t,y:e,type:"touchend"});this._emit(i),this.checkClick(i)}_emit(t){let e=[];switch(t.type){case"click":e=this.clickList;break;case"touchstart":e=this.touchstartList;break;case"touchmove":e=this.touchmoveList;break;case"touchend":e=this.touchendList}for(let i=0;i<e.length&&(!this.isPointInElement(t.x,t.y,e[i].element)||(t.currentTarget||(t.currentTarget=e[i].element),e[i].callback(t),!t.cancelBubble));i++);}isPointInElement(t,e,i){let{width:s,height:n}=i.renderStyles,r=t,h=e,o=i.parent;for(;o;)"scroll-view"===o.type&&this._isPointTouchElement(r,h,o)&&("x"===o.styles.direction?r-=o.currentScroll:h-=o.currentScroll),o=o.parent;return this._isPointTouchElement(r,h,i)}_isPointTouchElement(t,e,i){return t>=i.x&&e>=i.y&&t<=i.x+i.renderStyles.width&&e<=i.y+i.renderStyles.height}createEvent(t,e,i){}removeElement(t){this.clickList=this.clickList.filter(e=>e.element!==t),this.touchstartList=this.touchstartList.filter(e=>e.element!==t),this.touchmoveList=this.touchmoveList.filter(e=>e.element!==t),this.touchendList=this.touchendList.filter(e=>e.element!==t)}onClick(t,e){this.clickList.unshift({callback:t,element:e})}onTouchStart(t,e){this.touchstartList.unshift({callback:t,element:e})}onTouchMove(t,e){this.touchmoveList.unshift({callback:t,element:e})}onTouchEnd(t,e){this.touchendList.unshift({callback:t,element:e})}checkClick(t){if(this.touchStartEvent&&this.simulateClick){let{x:e,y:i}=this.touchStartEvent,{x:s,y:n}=t,r=n*n+s*s-(i*i+e*e);r<10&&r>-10&&this.click(s,n)}}}class m{constructor({x:t,y:e,type:i}){this.x=t,this.y=e,this.scrollX=t,this.scrollY=e,this.type=i,this.cancelBubble=!1,this.currentTarget=null}stopPropagation(){this.cancelBubble=!0}}class f{constructor(t,e){this.ctx=t,this.node=null,this.nodeList=[],this.renderList=[],this.options=e,this.eventManager=new u(e)}update(t,e){this.ctx=t,this.options=e,this.node.container=this.options}mountNode(t){this.node=t,this.node.layer=this,this.node.container=this.options,this.eventManager.clear(),this.initRender()}initRender(){this.nodeList=this.node.tree2List();this.initPaintList(),this.initNode(),this.flow(),this.repaint()}initNode(t=this.node){l(t,t=>{t.init()})}flow(t=this.node){l(t,t=>{t._initLayout()}),this.reflow()}initPaintList(){this.renderList=this.nodeList}reflow(t=this.node){l(t,t=>{t._reflow()})}repaint(t=this.node){this.ctx.clearRect(0,0,this.options.width,this.options.height),l(this.node,t=>{t._repaint(),t._afterPaint()}),this.ctx.draw&&this.ctx.draw()}getCanvas(){return this.options&&this.options.canvas}}class _ extends a{constructor(t,e){return super(t,e),t.styles.overflow="hidden",this.type="scroll-view",this._scrollView=new a(t,[this]),this._scrollView.type="scroll-view-container",this._scrollView}_getDefaultStyles(){return{...s.DEFAULT_STYLES,direction:"y"}}init(){super.init(),this.addEventListener();const{height:t,width:e,direction:i}=this.styles;"y"===i?r(t)?console.error("scroll-view 必须设置明确的高度"):(this.styles.height="auto",this.renderStyles.height="auto"):"x"===i&&(r(e)?console.error("scroll-view 必须设置明确的宽度"):(this.styles.width="auto",this.renderStyles.width="auto"))}addEventListener(){this.currentScroll=0;let t=this.styles.direction,e=0,i=0,s=!1,n=0,r=0,h=null,o=1;this.getLayer().eventManager.onTouchStart(n=>{n.stopPropagation(),e=n[t],i=e,s=!0,clearInterval(h)},this._scrollView),this.getLayer().eventManager.onTouchMove(r=>{s&&(r.stopPropagation(),n=r[t]-e,this.scrollBy(n)&&(i=e,e=r[t]))},this._scrollView),this.getLayer().eventManager.onTouchEnd(e=>{s&&(s=!1,r=2*(e[t]-i),o=.02*-r,clearInterval(h),h=setInterval(()=>{this.scrollBy(r)||clearInterval(h),r+=o,r*r<=.05&&(r=0,clearInterval(h))},18))},this._scrollView)}_repaint(){const{direction:t}=this.renderStyles;"y"===t?this.getCtx().translate(0,this.currentScroll):this.getCtx().translate(this.currentScroll,0),super._repaint()}calcScrollBound(t){const{contentWidth:e,contentHeight:i}=this._scrollView.renderStyles,{width:s,height:n,direction:r}=this.renderStyles;if("y"===r){if(i-this.currentScroll-t>n)return!1;if(this.currentScroll+t>0)return!1}else{if(e-this.currentScroll-t>s)return!1;if(this.currentScroll+t>0)return!1}return!0}scrollBy(t){return!!this.calcScrollBound(t)&&(this.currentScroll+=t,this.getLayer().repaint(),!0)}scrollTo(t){}}const S={};function L(t,e){if(S[t])throw Error(`Already exist tag name [${t}] !`);S[t]=e}L("view",(t,e)=>new a(t,e)),L("text",(t,e)=>new g(t,e)),L("image",(t,e)=>new c(t,e)),L("scroll-view",(t,e)=>new _(t,e)),L("scrollview",(t,e)=>new _(t,e));return{createLayer:function(t,e){return new f(t,e)},createElement:function(t){return t((function t(e,i={},s=[]){let n=null,r=s;if(!S[e])throw Error(`Unknown tag name [${e}] !`);return n=S[e](i,r,t),n}))},component:L,View:a,Text:g,Image:c,Layer:f,ScrollView:_}}));
