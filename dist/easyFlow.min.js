!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).easyFlow=e()}(this,(function(){"use strict";const t={BLOCK:"block",INLINE_BLOCK:"inline-block",INLINE:"inline",FLEX:"flex",NONE:"none"},e={AUTO:"auto",OUTER:"100%"},i={ROW:"row",COLUMN:"column"};var n={DISPLAY:t,WIDTH:e,POSITION:{ABSOLUTE:"absolute",FIXED:"fixed",RELATIVE:"relative",STATIC:"static"},DEFAULT_STYLES:{display:t.BLOCK,fontSize:14,fontWeight:400,fontFamily:"Microsoft Yahei",color:"#000",paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginTop:0,marginBottom:0,marginLeft:0,marginRight:0,height:e.AUTO,borderRadius:0,lineCap:"square",flexDirection:i.ROW,verticalAlign:"top",whiteSpace:"normal",zIndex:1},TEXT_ALIGN:{LEFT:"left",RIGHT:"right",CENTER:"center"},FLEX_DIRECTION:i};function s(t){return"number"==typeof t}function r(t){return"auto"===t}function h(t){if("string"==typeof t)return t.match("%")}function o(t){let e=parseInt(t.replace("%",""));return isNaN(e)||e<0?0:e/100}function l(t,e){e(t),t.hasChildren()&&t._getChildren().forEach(t=>{l(t,e)})}class d{constructor(t,e){this.options=t,this.children=e,this.styles=null,this.parent=null,this.renderStyles=null,this.x=0,this.y=0,this.pre=null,this.next=null,this.render=null,this.root=null,this.container=null}init(){this._initStyles(),this.initEvent()}initEvent(){if(this.options.on){const{click:t}=this.options.on;this.getLayer().eventManager.onClick(t,this)}}getLayer(){return this.root.layer}mount(t){t.mountNode(this)}_restore(t){this.getCtx().save(),t(),this.getCtx().restore()}_path(t){this.getCtx().beginPath(),t(),this.getCtx().closePath()}_initStyles(){this.styles=Object.assign({},this._getDefaultStyles(),this._getParentStyles(),this.options.styles||{}),this._completeStyles(),this.renderStyles={...this.styles}}_getParentStyles(){let{textAlign:t,lineHeight:e,fontSize:i,color:n,fontFamily:s,alignItems:r}=this.parent&&this.parent.styles||{},h={};return t&&(h.textAlign=t),e&&(h.lineHeight=e),i&&(h.fontSize=i),n&&(h.color=n),s&&(h.fontFamily=s),"flex-start"===r&&(h.verticalAlign="left"),"center"===r&&(h.verticalAlign="middle"),"flex-end"===r&&(h.verticalAlign="bottom"),h}_completeStyles(){this._completeFlex(),this._completeWidth(),this._completeBorder()}_completeBorder(){let{borderWidth:t,borderLeftWidth:e,borderRightWidth:i,borderBottomWidth:n,borderTopWidth:s,borderRadius:r}=this.styles;t||(this.styles.borderWidth=0,t=0),e||(this.styles.borderLeftWidth=t),i||(this.styles.borderRightWidth=t),n||(this.styles.borderBottomWidth=t),s||(this.styles.borderTopWidth=t),r&&(this.styles.overflow="hidden")}_completeWidth(){this.styles.width||this.styles.flex||(this.styles.display!==n.DISPLAY.INLINE_BLOCK&&this.styles.display!==n.DISPLAY.INLINE&&this.isInFlow()?this.styles.display!==n.DISPLAY.BLOCK&&this.styles.display!==n.DISPLAY.FLEX||(this.styles.width=n.WIDTH.OUTER):this.styles.width=n.WIDTH.AUTO)}_completeFlex(){this.parent&&this.parent.styles.display===n.DISPLAY.FLEX&&(this.styles.width||this.styles.flex||(this.styles.flex=1))}_getDefaultStyles(){return n.DEFAULT_STYLES}tree2List(){this.root=this;let t=this._connectChildren();return Array.isArray(t)?t:[t]}_connectChildren(){if(this.hasChildren()){const t=this._getChildren().map((t,e)=>(t._setParent(this),t._setSibling(this._getChildren()[e-1],this._getChildren()[e+1]),t._connectChildren())).reduce((t,e)=>[...t,...e]);return[this._generateRender(),...t]}return[this._generateRender()]}hasChildren(){return!(!Array.isArray(this.children)||!this.children.length)}_getChildren(){return this.hasChildren()?this.children:[]}_getChildrenInFlow(){return this._getChildren().filter(t=>t.isInFlow())}isInFlow(){const{position:t,display:e}=this.styles;return t!==n.POSITION.ABSOLUTE&&t!==n.POSITION.FIXED}_setParent(t){this.parent=t,this.root=t.root}_setSibling(t,e){this.pre=t,this.next=e}_generateRender(){return this}getCtx(){return this.root.layer.ctx}_reflow(){this._initStartingPoint(),this._walkParentLayout(),this._calcContentLayout(),this._patchAlign()}_repaint(){this.getCtx().save(),this._drawBox(),this._drawBackground(),this._drawContent()}_afterPaint(){if(this.hasChildren()||this.getCtx().restore(),this.parent&&!this.next&&!this.hasChildren()){this.getCtx().restore();let t=this.parent;for(;t&&!t.next;)this.getCtx().restore(),t=t.parent}}_drawBox(){}_drawContent(){}_drawBackground(){}_initLayout(){this._initClearWidthHeight(),this._calcContentLayout(),this._walkParentLayout(),this._initStartingPoint()}_initStartingPoint(){if(this.isInFlow())this._needNewLine()?(this.x=this._getContainerLayout().contentX,this.y=this._getPreLayout().y+this._getPreLayout().height):(this.x=this._getPreLayout().x+this._getPreLayout().width,this.y=this._getPreLayout().y);else{const{top:t,bottom:e,right:i,left:n,width:s,height:r}=this.renderStyles;let{contentX:h,contentY:o,contentWidth:l,contentHeight:d}=this._getContainerLayout();t?this.y=o+t:e&&(this.y=o+d-e-r),n?this.x=h+n:i&&(this.x=h+l-i-s)}}_walkParentLayout(){if(this.next||this.hasChildren())return;if(!this.isInFlow())return;let t=this;for(;t.parent&&(t.parent.styles.width===n.WIDTH.AUTO||t.parent.styles.height===n.WIDTH.AUTO);)t.parent._calcLayoutWithChildren(),t=t.parent}_initClearWidthHeight(){const{width:t,height:e,display:i,flex:r,marginLeft:l,marginRight:d,marginTop:a,marginBottom:c}=this.styles,g=this._measureLayout();r&&this.parent&&this.parent.renderStyles.display===n.DISPLAY.FLEX?this.renderStyles.width=this._getFlexWidth():h(t)?this.renderStyles.width=this._getContainerLayout().contentWidth*o(t):t===n.WIDTH.AUTO?this.renderStyles.width=g.width:s(t)&&(this.renderStyles.width=t+l+d),h(e)?this.renderStyles.height=this._getContainerLayout().contentHeight*o(e):e===n.WIDTH.AUTO?this.renderStyles.height=g.height:s(e)&&(this.renderStyles.height=e+a+c),this.renderStyles.marginTop=this.styles.borderTopWidth+this.styles.marginTop,this.renderStyles.marginBottom=this.styles.borderBottomWidth+this.styles.marginBottom,this.renderStyles.marginLeft=this.styles.borderLeftWidth+this.styles.marginLeft,this.renderStyles.marginRight=this.styles.borderRightWidth+this.styles.marginRight}_calcLayoutWithChildren(){const{width:t,height:e}=this.styles;t===n.WIDTH.AUTO&&(this.renderStyles.contentWidth=this._calcContentWidthWidthChildren()),e===n.WIDTH.AUTO&&(this.renderStyles.contentHeight=this._calcContentHeightWidthChildren()),this._calcLayoutWithContent()}_calcLayoutWithContent(){this.renderStyles.height=this.renderStyles.contentHeight+this.renderStyles.paddingTop+this.renderStyles.paddingBottom+this.renderStyles.marginTop+this.renderStyles.marginBottom,this.renderStyles.width=this.renderStyles.contentWidth+this.renderStyles.paddingLeft+this.renderStyles.paddingRight+this.renderStyles.marginLeft+this.renderStyles.marginRight}_calcContentLayout(){const{width:t,height:e}=this.styles,i=function(t){let e=t.renderStyles.width,i=t.renderStyles.height;s(e)||(e=0);s(i)||(i=0);return{contentWidth:e-t.renderStyles.paddingLeft-t.renderStyles.paddingRight-t.renderStyles.marginLeft-t.renderStyles.marginRight,contentHeight:i-t.renderStyles.paddingTop-t.renderStyles.paddingBottom-t.renderStyles.marginTop-t.renderStyles.marginBottom,contentX:t.x+t.renderStyles.paddingLeft+t.renderStyles.marginLeft,contentY:t.y+t.renderStyles.paddingTop+t.renderStyles.marginTop,width:e,height:i}}(this);this.renderStyles.contentWidth=i.contentWidth,this.renderStyles.contentHeight=i.contentHeight,this.contentX=i.contentX,this.contentY=i.contentY}_calcContentWidthWidthChildren(){let t=0,e=t;return this._getChildrenInFlow().forEach(i=>{i._needNewLine()&&(e=0),e+=i.renderStyles.width,e>t&&(t=e)}),t}_getFlexWidth(){if(!this.renderStyles.flex)return 0;const t=this._getContainerLayout().contentWidth;let e=0,i=0;return this.parent._getChildrenInFlow().forEach(t=>{s(t.styles.width)?e+=t.styles.width:t.renderStyles.flex&&(i+=t.renderStyles.flex)}),(t-e)*(this.renderStyles.flex/i)}_calcContentHeightWidthChildren(){let t=!0,e=0;const i=[];return this._getChildrenInFlow().forEach(n=>{"number"===(n.renderStyles.height,!1)&&(t=!1),n._needNewLine()?(i.push(e),e=n.renderStyles.height):n.renderStyles.height>e&&(e=n.renderStyles.height),n.next||(i.push(e),e=0)}),t?i.reduce((t,e)=>t+(e>=0?e:0)):this.renderStyles.height}_needNewLine(){const{display:t}=this.renderStyles,{whiteSpace:e}=this.parent&&this.parent.renderStyles||{};if(this.parent&&this.parent.renderStyles.display===n.DISPLAY.FLEX&&this.pre&&this.parent.renderStyles.flexDirection===n.FLEX_DIRECTION.ROW)return!1;if(t===n.DISPLAY.BLOCK||t===n.DISPLAY.FLEX)return!0;if("nowrap"===e)return!1;if(!this.pre)return!0;{let{width:t}=this.renderStyles;t===n.WIDTH.AUTO&&(t=0);const{display:e,width:i}=this.pre.renderStyles,{width:s,x:r}=this._getContainerLayout();if(e===n.DISPLAY.BLOCK||e===n.DISPLAY.FLEX)return!0;if(i+this.pre.x+t>r+s)return!0}return!1}_getContainerLayout(){let t=this.parent;return this.styles.position,n.POSITION.STATIC,t||(t={renderStyles:{width:this.container.width,height:this.container.height,paddingTop:0,paddingBottom:0,paddingLeft:0,paddingRight:0,marginLeft:0,marginRight:0,marginTop:0,marginBottom:0,contentWidth:this.container.width,contentHeight:this.container.height},x:0,y:0,contentX:0,contentY:0}),{width:t.renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y,paddingTop:t.renderStyles.paddingTop,paddingBottom:t.renderStyles.paddingBottom,paddingLeft:t.renderStyles.paddingLeft,paddingRight:t.renderStyles.paddingRight,marginLeft:t.renderStyles.marginLeft,marginRight:t.renderStyles.marginRight,marginTop:t.renderStyles.marginTop,marginBottom:t.renderStyles.marginBottom,contentX:t.contentX,contentY:t.contentY,contentWidth:t.renderStyles.contentWidth,contentHeight:t.renderStyles.contentHeight}}_getPreLayout(){let t=this.pre;for(;t&&!t.isInFlow();)t=t.pre;return t?{width:t.renderStyles.width,height:t.renderStyles.height,x:t.x,y:t.y}:{width:0,height:0,x:this._getContainerLayout().contentX,y:this._getContainerLayout().contentY}}_measureLayout(){return{width:0,height:0,x:0,y:0}}_px(t){return t}_patchAlign(){if(!this.parent)return;if(this.renderStyles.display!==n.DISPLAY.INLINE_BLOCK&&this.parent.renderStyles.display!==n.DISPLAY.FLEX)return;const t=this.parent.renderStyles.textAlign;this.renderStyles.verticalAlign;let e,i,s=0;const r=t=>{t.x+=i,t.contentX+=i,t._getChildrenInFlow().forEach(t=>l(t,t=>t.isInFlow()&&t._reflow()))},h=t=>{let e=0;"middle"===t.renderStyles.verticalAlign?e=(s-t.renderStyles.height)/2:"bottom"===t.renderStyles.verticalAlign&&(e=s-t.renderStyles.height),t.y+=e,t.contentY+=e,t._getChildrenInFlow().forEach(t=>l(t,t=>t.isInFlow()&&t._reflow()))},o=()=>{i="right"===t?this._getContainerLayout().contentWidth+this._getContainerLayout().contentX-e.x-e.renderStyles.width:"center"===t?(this._getContainerLayout().contentWidth+this._getContainerLayout().contentX-e.x-e.renderStyles.width)/2:0},d=()=>{e.renderStyles.height<=s||(s=e.renderStyles.height)};if(!this._needNewLine()&&this.next||!this.pre)this.next||this.pre||(e=this,o(),r(e));else{for(e=this.pre,this.next||(e=this,this._needNewLine()&&(o(),r(e),e=this.pre)),o();e&&(d(),r(e),e=e.pre,e);)if(e._needNewLine()){d(),r(e);break}for(e=this.pre,this.next||(e=this);e&&(h(e),e=e.pre,e);)if(e._needNewLine()){h(e);break}}}}class a extends d{_getDefaultStyles(){return{...n.DEFAULT_STYLES,display:n.DISPLAY.BLOCK}}_completeStyles(){super._completeStyles(),this._completePaddingMargin()}_completePaddingMargin(){this.styles.padding&&(this.styles.paddingLeft=this.styles.padding,this.styles.paddingBottom=this.styles.padding,this.styles.paddingRight=this.styles.padding,this.styles.paddingTop=this.styles.padding),this.styles.margin&&(this.styles.marginLeft=this.styles.margin,this.styles.marginBottom=this.styles.margin,this.styles.marginRight=this.styles.margin,this.styles.marginTop=this.styles.margin)}_reflow(){super._reflow()}_repaint(){super._repaint()}_afterPaint(){super._afterPaint()}_drawBackground(){const{backgroundColor:t,contentWidth:e,contentHeight:i,paddingLeft:n,paddingRight:s,paddingTop:r,paddingBottom:h}=this.renderStyles;this.getCtx();this._clip(),t&&(this.getCtx().fillStyle=t,this.getCtx().fillRect(this.contentX-n,this.contentY-r,e+n+s,i+r+h))}_drawBox(){this._drawRadiusBorder(),this.getLayer().options&&this.getLayer().options.debug&&(this.getCtx().strokeStyle="green",this.getCtx().strokeRect(this.contentX,this.contentY,this.renderStyles.contentWidth,this.renderStyles.contentHeight))}_drawRadiusBorder(){if(!this.renderStyles.borderColor&&!this.renderStyles.shadowBlur)return;const{contentWidth:t,contentHeight:e,paddingLeft:i,paddingTop:n,paddingRight:s,paddingBottom:r,shadowBlur:h,shadowColor:o,backgroundColor:l,borderLeftWidth:d,borderRightWidth:a,borderTopWidth:c,borderBottomWidth:g}=this.renderStyles,y=Math.PI/2;let u=this._getBorderRadius(),p=this.contentX-this.renderStyles.paddingLeft-d/2,S=this.contentY-this.renderStyles.paddingTop-c/2,_=t+i+s+(d+a)/2,f=e+n+r+(c+g)/2;const L=()=>{this.getCtx().moveTo(p,S+u),u&&this.getCtx().arc(p+u,S+u,u,2*y,3*y),this.getCtx().lineTo(p+_-u,S)},m=()=>{u&&this.getCtx().arc(p+_-u,S+u,u,3*y,4*y),this.getCtx().lineTo(p+_,S+f-u)},w=()=>{u&&this.getCtx().arc(p+_-u,S+f-u,u,0,y),this.getCtx().lineTo(p+u,S+f)},C=()=>{u&&this.getCtx().arc(p+u,S+f-u,u,y,2*y),this.getCtx().lineTo(p,S+u)};this.getCtx().lineCap=this.renderStyles.lineCap,this.getCtx().strokeStyle=this.renderStyles.borderColor;const x=t=>{this.getCtx().lineWidth=t,this.getCtx().stroke()};o&&h&&this._restore(()=>{this._path(()=>{L(),m(),w(),C()}),this.getCtx().shadowBlur=h,this.getCtx().shadowColor=o,this.getCtx().fillStyle=o,this.getCtx().fill()}),this._restore(()=>{this._path(()=>{p=this.contentX-this.renderStyles.paddingLeft-d/2,S=this.contentY-this.renderStyles.paddingTop-c/2,_=t+i+s+(d+a)/2,f=e+n+r+(c+g)/2,this.renderStyles.borderTopWidth&&(L(),x(this.renderStyles.borderTopWidth)),this.renderStyles.borderRightWidth&&(this.getCtx().moveTo(p+_-u,S),m(),x(this.renderStyles.borderRightWidth)),this.renderStyles.borderBottomWidth&&(this.getCtx().moveTo(p+_,S+f-u),w(),x(this.renderStyles.borderBottomWidth)),this.renderStyles.borderLeftWidth&&(this.getCtx().moveTo(p+u,S+f),C(),x(this.renderStyles.borderLeftWidth))})})}_clip(){if("hidden"!==this.renderStyles.overflow)return;const{contentWidth:t,contentHeight:e,paddingLeft:i,paddingTop:n,paddingRight:s,paddingBottom:r,shadowBlur:h,shadowColor:o,backgroundColor:l,borderLeftWidth:d,borderRightWidth:a,borderTopWidth:c,borderBottomWidth:g}=this.renderStyles,y=Math.PI/2;let u=this._getBorderRadius(),p=this.contentX-this.renderStyles.paddingLeft-d,S=this.contentY-this.renderStyles.paddingTop-c,_=t+i+s+d+a,f=e+n+r+c+g;const L=()=>{this.getCtx().moveTo(p,S+u),u&&this.getCtx().arc(p+u,S+u,u,2*y,3*y),this.getCtx().lineTo(p+_-u,S)},m=()=>{u&&this.getCtx().arc(p+_-u,S+u,u,3*y,4*y),this.getCtx().lineTo(p+_,S+f-u)},w=()=>{u&&this.getCtx().arc(p+_-u,S+f-u,u,0,y),this.getCtx().lineTo(p+u,S+f)},C=()=>{u&&this.getCtx().arc(p+u,S+f-u,u,y,2*y),this.getCtx().lineTo(p,S+u)};this._path(()=>{L(),m(),w(),C()}),this.getCtx().clip()}_getBorderRadius(){const{contentWidth:t,contentHeight:e}=this.renderStyles;let{borderRadius:i}=this.renderStyles;return 2*i>t&&(i=t/2),2*i>e&&(i=e/2),i<0&&(i=0),i}}class c extends d{constructor(t,e){super(t,e),this._layout=null,this._lines=[],this.children+=""}_getDefaultStyles(){return{...n.DEFAULT_STYLES,display:n.DISPLAY.INLINE,width:n.WIDTH.AUTO,textAlign:"left"}}_completeStyles(){super._completeStyles(),this._completeFont()}_completeFont(){this.styles.fontSize&&!this.styles.lineHeight?this.styles.lineHeight=1.4*this.styles.fontSize:this.styles.lineHeight||(this.styles.lineHeight=14)}_initLayout(){this._restore(()=>{this.getCtx().font=this._getFont(),this._layout=this.getCtx().measureText(this.children),this._layout.fontHeight=this.renderStyles.fontSize,this._layout.height=this.renderStyles.lineHeight,this._calcLine()}),super._initLayout()}_measureLayout(){return this._layout}_drawContent(){const{color:t,contentWidth:e,lineHeight:i,textAlign:s}=this.renderStyles;let r=this.contentX;this.getCtx().fillStyle=t,this.getCtx().textAlign=s,this.getCtx().font=this._getFont(),s===n.TEXT_ALIGN.RIGHT?r=this.contentX+e:s===n.TEXT_ALIGN.CENTER&&(r=this.contentX+e/2),this._lines.forEach((t,e)=>{this.getCtx().fillText(t,r,this.contentY+this._layout.fontHeight+(i-this._layout.fontHeight)/2+i*e-1)})}_getFont(){const{fontSize:t,fontWeight:e,fontFamily:i}=this.renderStyles;return`${e} ${t}px ${i}`}_calcLine(){if(!this.parent||!this.children)return;const{width:t,height:e}=this._layout,{contentWidth:i}=this.parent.renderStyles,{width:r}=this.parent.styles;if(s(i)&&i>=t||r===n.WIDTH.AUTO)this._lines=[this.children];else{this._lines=[];let t=1,e="",n=null;for(let s=0;s<this.children.length;s++){if(n=this.getCtx().measureText(e+this.children[s]),n.width>i){if(t>=this.renderStyles.maxLine){e=e.substring(0,e.length-2)+"...";break}this._lines.push(e),e="",t+=1}e+=this.children[s]}this._lines.push(e)}this._layout.height=this._lines.length*this.renderStyles.lineHeight}}class g extends a{init(){super.init(),this._imageInfo={width:0,height:0,contentWidth:0,contentHeight:0},this._image=null,this._loadImage()}_loadImage(){return new Promise((t,e)=>{var i,n;(i=this.options.attrs.src,n=this.getLayer().getCanvas(),new Promise((t,e)=>{let s=null;s=window?new Image:n.createImage(),s.src=i,s.onload=function(e){t({image:s,info:{width:e.target.width,height:e.target.height}})}})).then(({info:e,image:i})=>{this._imageInfo=e,this._image=i,t(),this._layoutImage(),this.getLayer().reflow(),this.getLayer().repaint()})})}_drawContent(){if(!this._image)return;const{contentWidth:t,contentHeight:e}=this.renderStyles;this.getCtx().drawImage(this._image,this.contentX,this.contentY,t,e)}_layoutImage(){const{contentWidth:t,contentHeight:e}=this.renderStyles;let{width:i,height:n}=this.styles;!r(i)&&r(n)?(i=t,n=function(t,e,i){return t/e*i}(i,this._imageInfo.width,this._imageInfo.height)):!r(n)&&r(i)?(n=e,i=function(t,e,i){return t/i*e}(n,this._imageInfo.width,this._imageInfo.height)):r(i)&&r(n)?(i=this._imageInfo.width,n=this._imageInfo.height):(i=t,n=e),this.renderStyles.contentWidth=i,this.renderStyles.contentHeight=n,this._calcLayoutWithContent()}}class y{constructor({simulateClick:t=!0}){this.clickList=[],this.touchstartList=[],this.touchmoveList=[],this.touchendList=[],this.touchStartEvent=null,this.simulateClick=t}clear(){this.clickList=[],this.touchstartList=[],this.touchmoveList=[],this.touchendList=[]}click(t,e){let i=new u({x:t,y:e,type:"click"});this._emit(i)}touchstart(t,e){let i=new u({x:t,y:e,type:"touchstart"});this.touchStartEvent=i,this._emit(i)}touchmove(t,e){let i=new u({x:t,y:e,type:"touchmove"});this._emit(i)}touchend(t,e){let i=new u({x:t,y:e,type:"touchend"});this._emit(i),this.checkClick(i)}_emit(t){let e=[];switch(t.type){case"click":e=this.clickList;break;case"touchstart":e=this.touchstartList;break;case"touchmove":e=this.touchmoveList;break;case"touchend":e=this.touchendList}for(let i=0;i<e.length&&(!this.isPointInElement(t.x,t.y,e[i].element)||(t.currentTarget||(t.currentTarget=e[i].element),e[i].callback(t),!t.cancelBubble));i++);}isPointInElement(t,e,i){const{width:n,height:s}=i.renderStyles;return t>=i.x&&e>=i.y&&t<=i.x+n&&e<=i.y+s}createEvent(t,e,i){}onClick(t,e){this.clickList.unshift({callback:t,element:e})}onTouchStart(t,e){this.touchstartList.unshift({callback:t,element:e})}onTouchMove(t,e){this.touchmoveList.unshift({callback:t,element:e})}onTouchEnd(t,e){this.touchendList.unshift({callback:t,element:e})}checkClick(t){if(this.touchStartEvent&&this.simulateClick){let{x:e,y:i}=this.touchStartEvent,{x:n,y:s}=t,r=s*s+n*n-(i*i+e*e);r<10&&r>-10&&this.click(n,s)}}}class u{constructor({x:t,y:e,type:i}){this.x=t,this.y=e,this.type=i,this.cancelBubble=!1,this.currentTarget=null}stopPropagation(){this.cancelBubble=!0}}class p{constructor(t,e){this.ctx=t,this.node=null,this.nodeList=[],this.renderList=[],this.options=e,this.eventManager=new y(e)}update(t,e){this.ctx=t,this.options=e,this.node.container=this.options}mountNode(t){this.node=t,this.node.layer=this,this.node.container=this.options,this.eventManager.clear(),this.initRender()}initRender(){const t=this.nodeList=this.node.tree2List();this.initPaintList(),t.forEach(t=>{t.init()}),this.flow(),this.repaint()}flow(){this.nodeList.forEach(t=>{t._initLayout()}),this.reflow()}initPaintList(){this.renderList=this.nodeList}reflow(){this.nodeList.forEach(t=>{t._reflow()})}repaint(t=this.node){this.ctx.clearRect(this.node.x,this.node.y,this.node.renderStyles.width,this.node.renderStyles.height),this.renderList.forEach(t=>{t._repaint(),t._afterPaint()}),this.ctx.draw&&this.ctx.draw()}getCanvas(){return this.options&&this.options.canvas}}class S extends a{constructor(t,e){return super(t,e),t.styles.overflow="hidden",this._scrollView=new a(t,[this]),this._scrollView}_getDefaultStyles(){return{...n.DEFAULT_STYLES,direction:"y"}}init(){super.init(),this.addEventListener();const{height:t,width:e,direction:i}=this.styles;"y"===i?r(t)?console.error("scroll-view 必须设置明确的高度"):(this.styles.height="auto",this.renderStyles.height="auto"):"x"===i&&(r(e)?console.error("scroll-view 必须设置明确的宽度"):(this.styles.width="auto",this.renderStyles.width="auto"))}addEventListener(){this.currentScroll=0;let t=this.styles.direction,e=0,i=0,n=!1,s=0,r=0,h=null,o=1;this.getLayer().eventManager.onTouchStart(s=>{s.stopPropagation(),e=s[t],i=e,n=!0,clearInterval(h)},this),this.getLayer().eventManager.onTouchMove(r=>{n&&(r.stopPropagation(),s=r[t]-e,this.scrollBy(s)&&(i=e,e=r[t]))},this),this.getLayer().eventManager.onTouchEnd(e=>{n&&(n=!1,r=2*(e[t]-i),o=.02*-r,clearInterval(h),h=setInterval(()=>{this.scrollBy(r)||clearInterval(h),r+=o,r*r<=.05&&(r=0,clearInterval(h))},18))},this)}_repaint(){const{direction:t}=this.renderStyles;"y"===t?this.getCtx().translate(0,this.currentScroll):this.getCtx().translate(this.currentScroll,0),super._repaint()}calcScrollBound(t){const{width:e,height:i}=this._scrollView.renderStyles,{width:n,height:s,direction:r}=this.renderStyles;if("y"===r){if(i-this.currentScroll-t>s)return!1;if(this.currentScroll+t>0)return!1}else{if(e-this.currentScroll-t>n)return!1;if(this.currentScroll+t>0)return!1}return!0}scrollBy(t){return!!this.calcScrollBound(t)&&(this.currentScroll+=t,this.getLayer().repaint(),!0)}scrollTo(t){}}const _={};function f(t,e){if(_[t])throw Error(`Already exist tag name [${t}] !`);_[t]=e}f("view",(t,e)=>new a(t,e)),f("text",(t,e)=>new c(t,e)),f("image",(t,e)=>new g(t,e)),f("scroll-view",(t,e)=>new S(t,e)),f("scrollview",(t,e)=>new S(t,e));return{createLayer:function(t,e){return new p(t,e)},createElement:function(t){return t((function t(e,i,n=[]){let s=null;if(!_[e])throw Error(`Unknown tag name [${e}] !`);return s=_[e](i,n,t),s}))},component:f,View:a,Text:c,Image:g,Layer:p,ScrollView:S}}));
